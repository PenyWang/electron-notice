<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Hello World!</title>
    <link rel="stylesheet" href="index.css" />
    <script src="./utils.js"></script>
  </head>
  <body>
    <h1>ğŸ’– Hello World!</h1>
    <p>Welcome to your Electron application.</p>
    <input id="todoInput" />
    <script>
      // todo
      // æ”¯æŒæ™šä¸Šå…«ç‚¹ååˆ† å…«ç‚¹åäº”
      const todoArr = [];
      const initItem = {
        time: 0, // æ—¶é—´æˆ³åŒæ—¶å……å½“id
        complete: false,
        title: "",
        content: "",
        isNoticed: false,
      };

      const timeStrs = ["åˆ†é’Ÿå", "å°æ—¶å"];
      const stepTime = ["ä¸Šåˆ", "ä¸‹åˆ", "æ™šä¸Š"];
      const stepTypes = ["ç‚¹åŠ", "ç‚¹", "åˆ†"];

      todoInput.addEventListener("keydown", (event) => {
        if (event.keyCode == 13) {
          const content = event.target.value.trim();
          const newItem = JSON.parse(JSON.stringify(initItem));
          const res = parseContent(content);
          console.log(res);
          todoArr.push({
            ...newItem,
            title: res.content,
            content: res.content,
            time: res.time,
          });
        }
      });

      //   æ—¶é—´åˆ°è¾¾ï¼Œå‘å‡ºé€šçŸ¥
      setInterval(function () {
        todoArr.forEach((item) => {
          if (isClock(item)) {
            notice(item);
          }
        });
      }, 500);

      function parseContent(content) {
        const contentObj = {};
        let contentArr = [];
        timeStrs.forEach((item) => {
          // åˆ†é’Ÿåã€å°æ—¶å
          if (content.indexOf(item) !== -1) {
            contentArr = content.split(item);
            if (contentArr.length > 1) {
              contentObj.time = parseTime(item, contentArr[0]);
              contentObj.content = contentArr[1];
            }
          }
        });
        if (contentObj.content && contentObj.time) return contentObj;
        // ä¸‹åˆ ä¸Šåˆ æ™šä¸Š
        stepTime.forEach((item) => {
          if (content.indexOf(item) !== -1) {
            // å¦‚æœæ˜¯ä¸Šåˆã€ä¸‹åˆã€æ™šä¸Š
            stepTypes.forEach((type) => {
              if (content.indexOf(type) !== -1) {
                // å¦‚æœæ˜¯ç‚¹åŠ ç‚¹ åˆ†
                if (type === "ç‚¹åŠ") {
                  const contentArr = content.split("ç‚¹åŠ"); // ä¸Šåˆå…«ç‚¹åŠ
                  if (contentArr.length > 1) {
                    let hour = contentArr[0].split(item)[1];
                    if (!hour) return;
                    contentObj.time = parseTime("ç‚¹åŠ", hour, item === "ä¸Šåˆ");
                    contentObj.content = contentArr[1];
                  }
                }
                if (contentObj.content && contentObj.time) return contentObj;
                if (type === "ç‚¹") {
                  const contentArr = content.split("ç‚¹"); // ä¸Šåˆå…«ç‚¹
                  if (contentArr.length > 1) {
                    let hour = contentArr[0].split(item)[1];
                    if (!hour) return;
                    contentObj.time = parseTime("ç‚¹", hour, item === "ä¸Šåˆ");
                    contentObj.content = contentArr[1];
                  }
                }
              }
            });
          }
        });
        return contentObj;
      }

      function parseTime(timeType, cnNum, isAm) {
        if (timeType === "åˆ†é’Ÿå") {
          return Date.now() + ChineseToNumber(cnNum) * 60 * 1000;
        }
        if (timeType === "å°æ—¶å") {
          return Date.now() + ChineseToNumber(cnNum) * 60 * 60 * 1000;
        }
        if (timeType === "ç‚¹åŠ" || timeType === "ç‚¹") {
          let hour = ChineseToNumber(cnNum);
          if (!isAm) hour += 12;
          const date = new Date();
          date.setHours(hour);
          if (timeType === "ç‚¹åŠ") date.setMinutes(30);
          return date.getTime();
        }
      }

      function isClock(todoItem) {
        if (!todoItem.isNoticed) {
          return todoItem.time < Date.now() ? true : false;
        }
      }

      function notice(todoItem) {
        try {
          console.log("é€šçŸ¥", todoItem);
          Notification.requestPermission().then((permission) => {
            if (permission == "granted") {
              const myNotification = new Notification(todoItem.title, {
                body: todoItem.content,
                vibrate: 10,
                timestamp: 20000,
              });
              todoItem.isNoticed = true;
              updateTodoArr(todoItem);
              myNotification.onclick = () => {
                todoItem.complete = true;
              };
            }
          });
        } catch (error) {
          console.log(error);
          todoItem.isNoticed = false;
          updateTodoArr(todoItem);
        }
      }

      function updateTodoArr(todoItem) {
        todoArr.forEach((item) => {
          if (todoItem.time === item.time) {
            Object.assign(item, todoItem);
          }
        });
      }
    </script>
  </body>
</html>
